<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>å³æ™‚äº¤é€šäº‹ä»¶åœ°åœ–</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  body { font-family: "Microsoft JhengHei", sans-serif; margin: 20px; }
  h2 { text-align: center; }
  #map { height: 600px; width: 100%; border-radius: 10px; }
  #event-list { max-height: 300px; overflow-y: auto; margin-top: 10px; border: 1px solid #ccc; border-radius: 6px; padding: 5px; }
  .event-item { padding: 6px; border-bottom: 1px solid #eee; }
  .event-item:hover { background-color: #f5f5f5; cursor: pointer; }
  #last-update { margin-top: 10px; font-weight: bold; }
</style>
</head>
<body>

<h2>ğŸš¦ å°ç£å³æ™‚äº¤é€šäº‹ä»¶åœ°åœ–</h2>
<div id="map"></div>
<div id="last-update">ä¸Šæ¬¡æ›´æ–°æ™‚é–“: --</div>
<div id="event-list"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let map = L.map('map').setView([23.7, 120.9], 7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let markers = [];
const categories = {
  "äº‹æ•…": "red",
  "äº¤é€šç®¡åˆ¶": "purple",
  "äº¤é€šéšœç¤™": "yellow",
  "å…¶ä»–": "blue",
  "ç½è®Š": "brown",
  "è™ŸèªŒæ•…éšœ": "gray",
  "é“è·¯æ–½å·¥": "orange",
  "é˜»å¡": "black"
};

// JSON URL â†’ è«‹æ”¹æˆä½  GitHub Pages çš„å®Œæ•´ URL
const jsonUrl = "https://raw.githubusercontent.com/computerproject135/trafficmonitoring/main/data/road_data.json";


// è®€å– JSON ä¸¦æ›´æ–°åœ°åœ–
async function loadEvents() {
  try {
    const response = await fetch(jsonUrl);
    if (!response.ok) throw new Error("è®€å– JSON å¤±æ•—");
    const events = await response.json();

    // æ¸…é™¤èˆŠæ¨™è¨˜
    markers.forEach(m => map.removeLayer(m));
    markers = [];
    const eventListDiv = document.getElementById('event-list');
    eventListDiv.innerHTML = '';

    events.forEach(event => {
      const lat = parseFloat(event.y1);
      const lng = parseFloat(event.x1);
      if (!lat || !lng) return;

      let category = "å…¶ä»–";
      switch (event.roadtype) {
        case "é“è·¯æ–½å·¥": category = "é“è·¯æ–½å·¥"; break;
        case "äº¤é€šäº‹æ•…": category = "äº‹æ•…"; break;
        case "äº¤é€šç®¡åˆ¶": category = "äº¤é€šç®¡åˆ¶"; break;
        case "é˜»å¡": category = "é˜»å¡"; break;
      }
      const color = categories[category] || "gray";

      const marker = L.circleMarker([lat, lng], {
        radius: 8,
        color: "#000",
        weight: 1,
        fillColor: color,
        fillOpacity: 0.8
      }).addTo(map);

      marker.bindPopup(`
        <b>${category}</b><br>
        ${event.comment || "ç„¡æè¿°"}<br>
        <small>${event.happendate} ${event.happentime}</small><br>
        <i>ä¾†æº: ${event.srcdetail || "æœªçŸ¥"}</i>
      `);

      markers.push({ marker, lat, lng });

      const div = document.createElement('div');
      div.className = 'event-item';
      div.innerHTML = `<span style="color:${color};font-weight:bold">${category}</span> - ${event.comment || "ç„¡æè¿°"} <small>(${event.happendate} ${event.happentime})</small> <i>[${event.srcdetail || "æœªçŸ¥"}]</i>`;
      // é»æ“Šäº‹ä»¶åˆ—è¡¨ï¼Œåœ°åœ–è‡ªå‹•ç¸®æ”¾åˆ°æ¨™è¨˜
      div.onclick = () => {
        map.setView([lat, lng], 14);
        marker.openPopup();
      };
      eventListDiv.appendChild(div);
    });

    // æ›´æ–°ä¸Šæ¬¡è®€å–æ™‚é–“
    const now = new Date();
    document.getElementById('last-update').innerText = "ä¸Šæ¬¡æ›´æ–°æ™‚é–“: " + now.toLocaleString();

  } catch (err) {
    console.error(err);
    alert("ç„¡æ³•è®€å– JSONï¼Œè«‹ç¢ºèª JSON å·² push åˆ° GitHub Pages ä¸¦ä½¿ç”¨æ­£ç¢º URLã€‚");
  }
}

// åˆå§‹åŒ–
loadEvents();

// æ¯ 10 åˆ†é˜è‡ªå‹•æ›´æ–°ä¸€æ¬¡
setInterval(loadEvents, 600000);
</script>
</body>
</html>

